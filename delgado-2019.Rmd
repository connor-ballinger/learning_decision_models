---
title: "Ovarian Cancer in Spain: Delgado-Ortega 2019"
date: "`r conr::format_date()`"
author: "Connor Ballinger"
knit: conr::write_and_date
output: conr::format_html
---

```{r, warning=FALSE, message=FALSE}
# knitr::opts_chunk$set()

# library(here)
library(tidyverse)
# library(knitr)
# library(hesim)
# library(data.table)

# registerS3method("knit_print", "data.frame", conr::knit_print.data.frame)

theme_set(theme_bw() + theme(legend.position = "bottom"))

```

# Overview

-   Epithelial OC (90% of OC is used).

-   3-state Markov (stable, progressed, death), stratified by the 4 stages. 

-   10-year horizon, societal perspective.

-   “The cycle length used was 3 weeks (21 days), which is the length of a chemotherapy cycle. Patients entered the model after they were diagnosed with EOC in the stable state. A cycle after, they can either remain stable, become worse, and move to a post-progression state, or die. Those who progress remain in a post-progression state until they die.” 

-   Used Heintz 2006 for survival. Heintz only provided 5-year survival data – Delgado extrapolated based on exponential distribution ie time-constant transition probabilities.

-   Recall there may be no treatment effects applied - may just use Olaparib survival curves directly in an appropriate sub-population.

-   Note age-specific probabilities of death (incorporating OC mortality rate and background mortality rate).

    -   Add 2 rates and then calculate probability, or calculate probabilities and add? Delgado uses the latter. Always the latter.

# To do

-   Add yearly cohort with pop growth too. 

-   Add costs.

-   Construct a critique, including any Aus contextual factors.

-   Add equations.

# Following DARTH Framework (Alarid 2023)

## Structure

```{r}
n_cycle_length <- 3 / 52 # 3 weeks
n_cycles <- round(10 * 52 / 3) # 10 years

v_names_states <- c("Stable", "Progressed", "Dead")
v_names_stages <- c("I", "II", "III", "IV")
```

## Patients

```{r}
df_ages <- data.frame(cycle = 0:n_cycles, 
                      I = 57.4, 
                      II = 62.4, 
                      III = 64.9, 
                      IV = 68.1)
df_ages <- df_ages |>
  mutate(across(I:IV, ~ round(cycle / (52/3) + .x)))

df_ages_long <- df_ages |>
  pivot_longer(cols = -cycle, names_to = "stage", 
               values_to = "age", cols_vary = "slowest")

```

## Transitions

-   Formulas in Delgado suggest probabilities vary over time, but they have assumed exponential so I don't see how.

### Background Mortality

-   Tricky to separate this from other transition rates...

```{r}
life_table <- readxl::read_xlsx("abs_life_tables_2019-2021.xlsx", 
                                sheet = "Table_1.9",
                                skip = 6)
life_table <- life_table |> 
  select(Age, rate...7) |> 
  rename(age = Age, rate_annual_mort = rate...7)

# convert annual rate to 3-weekly rate

life_table <- life_table |> 
  mutate(age = as.integer(age),
         rate_bgr_mort = rate_annual_mort / (52/3)) |> 
  filter(age > 55) |> 
  select(age, rate_bgr_mort)

# ignore NA warning, that is due to ABS adding text below data

df_bgr_mort <- df_ages_long |> 
  left_join(life_table, by = "age")
```

-   Need to get other mortality rate (and that requires pfs rate).

```{r}
v_median_pfs <- c(18.33, 6.25, 2.00, 1.60)
v_median_os <- c(19.50, 7.50, 3.20, 1.90)

v_lambda_pfs <- - log(0.5) / v_median_pfs
v_3r_pfs <- v_lambda_pfs / (52/3) # 3-weekly rate

v_lambda_os <- - log(0.5) / (v_median_os - v_median_pfs)
v_3r_os <- v_lambda_os / (52/3) # 3-weekly rate

df_rates <- tibble(stage = v_names_stages,
                   rate_pfs = v_3r_pfs,
                   rate_os = v_3r_os)

df_prob <- df_bgr_mort |> 
  left_join(df_rates, by = "stage") |> 
  mutate(across(.cols = starts_with("rate"),
                .fns = ~ 1 - exp(-.x),
                .names = "prob_{.col}")) |> 
  rename_with(.fn = ~ sub("_rate", "", .x), .cols = everything()) |> 
  mutate(prob_s_p = prob_pfs,
         prob_s_d = prob_bgr_mort,
         prob_p_d = prob_os + prob_bgr_mort) |> 
  select(cycle, stage, prob_s_p, prob_s_d, prob_p_d)

```

-   Convert to array.

```{r}
# Split df_prob by Stage

df_prob_stages <- split(df_prob, df_prob$stage)
names(df_prob_stages) <- v_names_stages

# Initialise probability array

a_prob <- array(data = as.double(NA), 
                dim = c(3, 3, 4, (n_cycles+1)), 
                dimnames = list("from" = v_names_states, 
                                "to" = v_names_states,
                                "stage" = v_names_stages,
                                "cycle" = 0:n_cycles))
# Prevent some transitions

a_prob["Dead", "Stable", , ] <- 
  a_prob["Dead", "Progressed", , ] <- 
  a_prob["Progressed", "Stable", , ] <- 0

# Dead stay dead

a_prob["Dead", "Dead", , ] <- 1

# Use purrr::walk fn such that assignments made for each Stage

# S to P
v_names_stages |> 
  walk(\(x) a_prob["Stable", "Progressed", x, ] <<- 
         df_prob_stages[[x]]$prob_s_p)

# S to D
v_names_stages |> 
  walk(\(x) a_prob["Stable", "Dead", x, ] <<-  
         df_prob_stages[[x]]$prob_s_d)

# P to D
v_names_stages |> 
  walk(\(x) a_prob["Progressed", "Dead", x, ] <<- 
         df_prob_stages[[x]]$prob_p_d)

# S to S means neither S to P nor S to D occur
v_names_stages |> 
  walk(\(x) a_prob["Stable", "Stable", x, ] <<- 
         (1 - a_prob["Stable", "Progressed", x, ] - 
            a_prob["Stable", "Dead", x, ]))

# P to P means P to D does not occur
v_names_stages |> 
  walk(\(x) a_prob["Progressed", "Progressed", x, ] <<- 
         (1 - a_prob["Progressed", "Dead", x, ]))
```

## Checks

```{r}
sum(a_prob >= 0 & a_prob <= 1) - length(a_prob)

tracker <- 0

for (stage in v_names_stages) {
  for (t in 1:n_cycles+1) {
    tracker = tracker + rowSums(a_prob[, , stage, t]) - 1
  }
}
tracker # should be zero
```

## Construct Trace

```{r}
v_init_stages <- c(1155, 195, 1116, 681) # Delgado figures
# v_init_stages <- c(0.37, 0.06, 0.35, 0.22) # rough portions
# v_init_stages <- rep.int(1, times = 4)
v_init_states <- c(1, 0, 0) # all patients start in stable state

a_trace <- array(data = NA, 
               dim = c(3, 4, n_cycles+1), 
               dimnames = list("state" = v_names_states,
                               "stage" = v_names_stages,
                               "cycle" = 0:n_cycles))

a_trace[, , "0"] <- v_init_states %o% v_init_stages


for (stage in v_names_stages) {
  for (t in 2:(n_cycles + 1)) { # indexing by integer, not cycle name. cycle_name = integer - 1.
    a_trace[, stage, t] <- a_trace[, stage, t-1] %*% a_prob[, , stage, t]
  }
}

```

## Gather Results

```{r}
df <- as.data.frame(aperm(a_trace)) |>
  mutate(Cycle = 0:n_cycles) |> 
  pivot_longer(cols = -(Cycle), 
               names_to = c("Stage", "State"),
               names_sep = "\\.",
               values_to = "N") |> 
  mutate(Year = Cycle * n_cycle_length,
         State = factor(State, 
                        levels = c("Stable", "Progressed", "Dead"), 
                        ordered = TRUE))

ggplot(data = df) +
  geom_line(aes(x = Year, y = N, colour = Stage)) +
  facet_wrap(vars(State)) #, scales = "free_y")
```

## Costs

-   Overarching figures:

```{r}
n_cpi_med <- 0.0077
n_cpi <- 0.0197
n_discount_rate <- 0.03
n_econ_growth <- 0.01
```

-   Patients:

```{r}
n_weight <- 66
n_height <- 160
```

-   Service use:

```{r}
n_brca_ref_rate <- 0.2
n_brca_ref_visits <- 2
n_brca_pos_rate <- 0.05
n_brca_family_refs <- 5
```

